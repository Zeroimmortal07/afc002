<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amma Food Center - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(180deg, #f5f3ff 0%, #ffffff 100%);
        }

        .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
        }

        .card-hover {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            background-color: #faf5ff;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
    </style>
</head>

<body class="min-h-screen">

    <!-- Login Section (Initially Visible) -->
    <div id="login-section" class="login-container">
        <div class="w-full max-w-md">
            <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
                <!-- Login Header -->
                <div class="gradient-purple text-white p-8 text-center">
                    <div class="text-6xl mb-4">üîê</div>
                    <h1 class="text-3xl font-bold mb-2">Admin Login</h1>
                    <p class="text-purple-100 text-sm">Amma Food Center Dashboard</p>
                </div>

                <!-- Login Form -->
                <div class="p-8">
                    <form id="login-form" class="space-y-5">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Username</label>
                            <input type="text" id="username" required
                                class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-purple-500 focus:outline-none transition-colors font-medium"
                                placeholder="Enter username">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Password</label>
                            <input type="password" id="password" required
                                class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-purple-500 focus:outline-none transition-colors font-medium"
                                placeholder="Enter password">
                        </div>

                        <div id="login-error"
                            class="hidden bg-red-50 border-2 border-red-200 text-red-600 px-4 py-3 rounded-xl text-sm font-semibold">
                            Invalid credentials
                        </div>

                        <button type="submit"
                            class="w-full gradient-purple text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-105 active:scale-95">
                            üöÄ Login to Dashboard
                        </button>
                    </form>

                    <div class="mt-6 text-center text-sm text-gray-500">
                        <p>Default credentials:</p>
                        <p class="font-mono bg-gray-50 rounded-lg p-2 mt-2">
                            <strong>Username:</strong> admin<br>
                            <strong>Password:</strong> amma123
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Section (Initially Hidden) -->
    <div id="dashboard-section" class="hidden p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="gradient-purple text-white rounded-2xl p-6 mb-6 shadow-xl">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold">Admin Dashboard</h1>
                        <p class="text-purple-100 mt-1">Manage orders and menu items</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="last-updated" class="text-sm text-purple-100 font-medium">Updating...</span>
                        <button onclick="fetchData()"
                            class="bg-white text-purple-600 px-5 py-2 rounded-xl font-bold hover:shadow-lg transition-all transform hover:scale-105">
                            üîÑ Refresh
                        </button>
                        <button onclick="logout()"
                            class="bg-red-500 text-white px-5 py-2 rounded-xl font-bold hover:bg-red-600 transition-all transform hover:scale-105">
                            üö™ Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex space-x-3 mb-6">
                <button onclick="switchTab('orders')" id="tab-orders"
                    class="px-6 py-3 rounded-xl font-bold transition-all bg-purple-600 text-white shadow-lg">
                    üì¶ Orders
                </button>
                <button onclick="switchTab('menu')" id="tab-menu"
                    class="px-6 py-3 rounded-xl font-bold transition-all bg-white text-gray-600 hover:bg-purple-50">
                    üçΩÔ∏è Manage Menu
                </button>
            </div>

            <!-- Orders Section -->
            <div id="section-orders" class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-purple-50 border-b-2 border-purple-200">
                        <tr>
                            <th class="p-5 font-bold text-purple-900 text-sm">‚è∞ Time</th>
                            <th class="p-5 font-bold text-purple-900 text-sm">üë§ Customer</th>
                            <th class="p-5 font-bold text-purple-900 text-sm">üõí Items</th>
                            <th class="p-5 font-bold text-purple-900 text-sm">üí∞ Total</th>
                            <th class="p-5 font-bold text-purple-900 text-sm">üìä Status</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table" class="divide-y divide-gray-100">
                        <!-- Orders will be injected here -->
                    </tbody>
                </table>
            </div>

            <!-- Menu Section -->
            <div id="section-menu" class="hidden space-y-6">
                <!-- Add Item Form -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
                    <h2 class="text-xl font-bold mb-5 text-gray-900">‚ûï Add New Menu Item</h2>
                    <form id="add-item-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Item Name</label>
                                <input type="text" id="new-name"
                                    class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-purple-500 focus:outline-none transition-colors font-medium"
                                    placeholder="e.g., Mysore Masala Dosa" required>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Price (‚Çπ)</label>
                                <input type="number" id="new-price"
                                    class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-purple-500 focus:outline-none transition-colors font-medium"
                                    placeholder="e.g., 80" required>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Category</label>
                                <select id="new-category"
                                    class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-purple-500 focus:outline-none transition-colors font-medium">
                                    <option>Breakfast</option>
                                    <option>Lunch</option>
                                    <option>Dinner</option>
                                    <option>Snacks</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Image</label>
                                <div class="flex flex-col space-y-2">
                                    <input type="file" id="new-image-file" accept="image/*"
                                        class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-purple-500 focus:outline-none transition-colors font-medium file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                                    <div class="text-center text-gray-400 text-sm font-medium">- OR -</div>
                                    <input type="text" id="new-image-url"
                                        class="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-purple-500 focus:outline-none transition-colors font-medium"
                                        placeholder="Enter Image URL (https://...)"
                                        value="https://images.unsplash.com/photo-1589301760574-0a6f91d25815?auto=format&fit=crop&w=300&q=80">
                                </div>
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full gradient-purple text-white py-3 px-4 rounded-xl font-bold hover:shadow-lg transition-all transform hover:scale-105">
                            ‚ú® Add Item to Menu
                        </button>
                    </form>
                </div>

                <!-- Menu List -->
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-purple-50 border-b-2 border-purple-200">
                            <tr>
                                <th class="p-5 font-bold text-purple-900 text-sm">üñºÔ∏è Image</th>
                                <th class="p-5 font-bold text-purple-900 text-sm">üìù Name</th>
                                <th class="p-5 font-bold text-purple-900 text-sm">üè∑Ô∏è Category</th>
                                <th class="p-5 font-bold text-purple-900 text-sm">üíµ Price</th>
                                <th class="p-5 font-bold text-purple-900 text-sm">‚öôÔ∏è Actions</th>
                            </tr>
                        </thead>
                        <tbody id="menu-table" class="divide-y divide-gray-100">
                            <!-- Menu items will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const API_URL = CONFIG.API_URL;
        let currentTab = 'orders';
        let isLoggedIn = false;

        // --- CHECK AUTH STATUS ON LOAD ---
        window.addEventListener('DOMContentLoaded', () => {
            const authToken = localStorage.getItem('adminToken');
            if (authToken === 'admin-authenticated') {
                showDashboard();
            }
        });

        // --- LOGIN ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            try {
                const response = await fetch(`${API_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (result.success) {
                    localStorage.setItem('adminToken', result.token);
                    errorDiv.classList.add('hidden');
                    showDashboard();
                } else {
                    errorDiv.textContent = result.message;
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Connection error. Is the server running?';
                errorDiv.classList.remove('hidden');
            }
        });

        // --- SHOW/HIDE SECTIONS ---
        function showDashboard() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            isLoggedIn = true;
            fetchData();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
            isLoggedIn = false;
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // --- TABS ---
        function switchTab(tab) {
            currentTab = tab;

            // Update Buttons
            document.getElementById('tab-orders').className = tab === 'orders'
                ? "px-6 py-3 rounded-xl font-bold transition-all bg-purple-600 text-white shadow-lg"
                : "px-6 py-3 rounded-xl font-bold transition-all bg-white text-gray-600 hover:bg-purple-50";
            document.getElementById('tab-menu').className = tab === 'menu'
                ? "px-6 py-3 rounded-xl font-bold transition-all bg-purple-600 text-white shadow-lg"
                : "px-6 py-3 rounded-xl font-bold transition-all bg-white text-gray-600 hover:bg-purple-50";

            // Show/Hide Sections
            document.getElementById('section-orders').classList.toggle('hidden', tab !== 'orders');
            document.getElementById('section-menu').classList.toggle('hidden', tab !== 'menu');

            fetchData();
        }

        // --- DATA FETCHING ---
        async function fetchData() {
            if (!isLoggedIn) return;

            const btn = document.querySelector('button[onclick="fetchData()"]');
            if (!btn) return;

            const originalText = btn.innerHTML;
            btn.innerHTML = "‚è≥ Loading...";

            try {
                if (currentTab === 'orders') {
                    await fetchOrders();
                } else {
                    await fetchMenu();
                }
                document.getElementById('last-updated').innerText = "Last updated: " + new Date().toLocaleTimeString();
            } catch (error) {
                console.error("Error fetching data:", error);
                alert("‚ö†Ô∏è Error fetching data. Is the server running?");
            } finally {
                btn.innerHTML = originalText;
            }
        }

        async function fetchOrders() {
            const response = await fetch(`${API_URL}/orders`);
            const orders = await response.json();
            renderOrders(orders);
        }

        async function fetchMenu() {
            const response = await fetch(`${API_URL}/menu`);
            const menu = await response.json();
            renderMenu(menu);
        }

        // --- RENDERING ---
        function renderOrders(orders) {
            const tbody = document.getElementById('orders-table');
            if (orders.length === 0) {
                tbody.innerHTML = `<tr>
                        <td colspan="5" class="p-12 text-center">
                            <div class="text-6xl mb-3">üì≠</div>
                            <p class="text-gray-500 font-semibold">No orders yet</p>
                        </td>
                    </tr>`;
                return;
            }
            tbody.innerHTML = orders.map(order => {
                const date = new Date(order.timestamp).toLocaleString();
                const itemsHtml = order.items.map(i => `<div class="text-sm text-gray-600"><span
                            class="font-bold text-purple-600">${i.quantity}√ó</span> ${i.name}</div>`).join('');

                const status = order.status || 'pending';
                const isPending = status === 'pending';
                const bgClass = isPending ? 'bg-yellow-100' : 'bg-green-100';
                const textClass = isPending ? 'text-yellow-800' : 'text-green-800';
                const borderClass = isPending ? 'border-yellow-300' : 'border-green-300';

                return `
                    <tr class="card-hover">
                        <td class="p-5 text-sm text-gray-600 whitespace-nowrap font-medium">${date}</td>
                        <td class="p-5">
                            <div class="font-bold text-gray-900">${order.name}</div>
                            <div class="text-xs text-gray-500 mt-1">${order.address}</div>
                            ${order.phone ? `<a href="https://wa.me/${order.phone.replace(/[^0-9]/g, '')}" target="_blank" class="text-green-600 hover:text-green-800 text-xs font-semibold flex items-center gap-1 mt-1">üìû ${order.phone}</a>` : ''}
                        </td>
                        <td class="p-5">${itemsHtml}</td>
                        <td class="p-5 font-bold text-lg text-purple-600">‚Çπ${order.totalPrice}</td>
                        <td class="p-5">
                            <div class="flex flex-col gap-2">
                                <select onchange="updateOrderStatus('${order.id}', this.value)" 
                                    class="${bgClass} ${textClass} ${borderClass} text-xs font-bold px-3 py-2 rounded-full border-2 cursor-pointer hover:opacity-80 transition-opacity focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="pending" ${isPending ? 'selected' : ''}>‚è≥ Pending</option>
                                    <option value="delivered" ${!isPending ? 'selected' : ''}>‚úÖ Delivered</option>
                                </select>
                                <button onclick="deleteOrder('${order.id}')" class="text-red-500 hover:text-red-700 text-xs font-bold flex items-center gap-1 justify-center mt-1">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </td>
                    </tr>`;
            }).join('');
        }

        function renderMenu(menu) {
            const tbody = document.getElementById('menu-table');
            tbody.innerHTML = menu.map(item => `
                    <tr class="card-hover">
                        <td class="p-5">
                            <img src="${item.image}"
                                class="w-16 h-16 rounded-xl object-cover bg-gray-100 border-2 border-gray-200 shadow-sm">
                        </td>
                        <td class="p-5 font-bold text-gray-900">${item.name}</td>
                        <td class="p-5">
                            <span
                                class="text-sm text-gray-600 bg-purple-50 px-3 py-1 rounded-full font-medium">${item.category}</span>
                        </td>
                        <td class="p-5 font-bold text-lg text-purple-600">‚Çπ${item.price}</td>
                        <td class="p-5">
                            <button onclick="deleteItem(${item.id})"
                                class="text-red-500 hover:text-red-700 font-bold text-sm bg-red-50 px-4 py-2 rounded-lg hover:bg-red-100 transition-colors">
                                üóëÔ∏è Delete
                            </button>
                        </td>
                    </tr>
                    `).join('');
        }

        // --- ACTIONS ---
        async function updateOrderStatus(id, newStatus) {
            try {
                const response = await fetch(`${API_URL}/orders/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    fetchData();
                } else {
                    alert("‚ö†Ô∏è Failed to update status");
                }
            } catch (error) {
                console.error("Error updating status:", error);
                alert("‚ö†Ô∏è Error updating order status");
            }
        }

        async function deleteOrder(id) {
            if (confirm("üóëÔ∏è Are you sure you want to delete this order?")) {
                try {
                    const response = await fetch(`${API_URL}/orders/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        fetchData();
                        alert("‚úÖ Order deleted successfully!");
                    } else {
                        alert("‚ö†Ô∏è Failed to delete order");
                    }
                } catch (error) {
                    console.error("Error deleting order:", error);
                    alert("‚ö†Ô∏è Error deleting order");
                }
            }
        }

        document.getElementById('add-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('new-name').value;
            const price = parseInt(document.getElementById('new-price').value);
            const category = document.getElementById('new-category').value;
            const imageFile = document.getElementById('new-image-file').files[0];
            const imageUrlInput = document.getElementById('new-image-url').value;

            let finalImageUrl = imageUrlInput;

            // Handle Image Upload
            if (imageFile) {
                const formData = new FormData();
                formData.append('image', imageFile);

                try {
                    const uploadResponse = await fetch(`${API_URL}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const uploadResult = await uploadResponse.json();

                    if (uploadResult.success) {
                        finalImageUrl = uploadResult.imageUrl;
                    } else {
                        alert("‚ö†Ô∏è Image upload failed: " + uploadResult.error);
                        return;
                    }
                } catch (error) {
                    console.error("Upload error:", error);
                    alert("‚ö†Ô∏è Error uploading image");
                    return;
                }
            }

            const newItem = {
                name,
                price,
                category,
                image: finalImageUrl
            };

            try {
                await fetch(`${API_URL}/menu`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newItem)
                });

                document.getElementById('add-item-form').reset();
                // Reset file input manually
                document.getElementById('new-image-file').value = '';
                fetchData();
                alert("‚úÖ Item added successfully!");
            } catch (error) {
                alert("‚ö†Ô∏è Error adding item");
            }
        });

        async function deleteItem(id) {
            if (confirm("üóëÔ∏è Are you sure you want to delete this item?")) {
                try {
                    await fetch(`${API_URL}/menu/${id}`, { method: 'DELETE' });
                    fetchData();
                    alert("‚úÖ Item deleted successfully!");
                } catch (error) {
                    alert("‚ö†Ô∏è Error deleting item");
                }
            }
        }

        // Auto-refresh every 30 seconds when logged in
        setInterval(() => {
            if (isLoggedIn) {
                fetchData();
            }
        }, 30000);
    </script>
</body>

</html>